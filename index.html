<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gold MCX Verdict</title>
  <meta name="theme-color" content="#0b0f14" />
  <style>
    :root{
      color-scheme: dark;
      --bg:#0b0f14;
      --panel:#0f1722;
      --card:#111c2a;
      --muted:#9fb0c3;
      --text:#e6edf3;
      --line:rgba(255,255,255,.08);
      --ok:#2fe67a;
      --warn:#ffd24a;
      --bad:#ff5c7a;
      --chip:#0c1320;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 800px at 20% 0%, rgba(72, 61, 255, 0.18), transparent 60%),
        radial-gradient(900px 600px at 90% 10%, rgba(0, 212, 255, 0.12), transparent 55%),
        var(--bg);
      color:var(--text);
      padding:24px;
    }
    .wrap{max-width:1000px;margin:0 auto}
    header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      margin-bottom:14px; flex-wrap:wrap;
    }
    .brand{display:flex;flex-direction:column;gap:4px}
    .brand h1{margin:0;font-size:22px;letter-spacing:.2px}
    .brand .sub{color:var(--muted);font-size:13px}
    .top-actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .btn{
      appearance:none;border:1px solid var(--line);background:rgba(255,255,255,.03);
      color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;
      font-weight:700;font-size:13px;
    }
    .btn:hover{background:rgba(255,255,255,.06)}
    .grid{display:grid;grid-template-columns: 1.2fr .8fr;gap:14px}
    @media (max-width:900px){ .grid{grid-template-columns:1fr} }

    .panel{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
      border-radius:18px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .panel .hd{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      background:rgba(0,0,0,.18);
      flex-wrap:wrap;
    }
    .panel .hd .t{font-weight:900;font-size:14px}
    .panel .hd .meta{color:var(--muted);font-size:12px}
    .panel .bd{padding:16px}
    .big{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .verdict{display:flex;flex-direction:column;gap:8px}
    .verdict .label{color:var(--muted);font-size:12px}
    .verdict .value{font-size:44px;line-height:1;font-weight:950;letter-spacing:.5px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      font-weight:900;font-size:12px;
    }
    .dot{width:10px;height:10px;border-radius:50%}
    .ok{background:var(--ok)}
    .warn{background:var(--warn)}
    .bad{background:var(--bad)}

    .k{
      border:1px solid var(--line);
      background:rgba(255,255,255,.02);
      border-radius:14px;
      padding:12px;
    }
    .k .h{color:var(--muted);font-size:12px;margin-bottom:6px}
    .k .v{font-weight:900}
    .k .v.small{font-weight:700;color:var(--text);opacity:.92;font-size:13px;line-height:1.35}

    .kv{display:grid;grid-template-columns: 1fr 1fr;gap:10px;margin-top:14px}
    @media (max-width:560px){ .kv{grid-template-columns:1fr} }

    .row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:10px}
    input[type="search"]{
      width:min(420px, 100%);
      padding:10px 12px;border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
    }

    table{width:100%;border-collapse:collapse;font-size:12px}
    th,td{padding:10px 8px;border-bottom:1px solid var(--line);vertical-align:top}
    th{color:var(--muted);text-align:left;font-weight:900;background:rgba(0,0,0,.12)}
    tr:hover td{background:rgba(255,255,255,.02)}

    .tag{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 9px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.02);
      font-weight:950;font-size:11px;
      white-space:nowrap;
    }
    .tag.buy{border-color:rgba(46,230,122,.35);color:rgba(46,230,122,.95)}
    .tag.sell{border-color:rgba(255,92,122,.35);color:rgba(255,92,122,.95)}
    .tag.hold{border-color:rgba(255,210,74,.35);color:rgba(255,210,74,.95)}

    .muted{color:var(--muted)}
    .foot{margin-top:14px;color:var(--muted);font-size:12px;line-height:1.35}
    .err{
      border:1px solid rgba(255,92,122,.35);
      background:rgba(255,92,122,.08);
      padding:10px 12px;border-radius:14px;
      color:#ffdbe2;
    }
    code.inline{background:rgba(255,255,255,.06);padding:2px 6px;border-radius:8px}

    /* Confidence bar */
    .barWrap{margin-top:10px; width:min(360px,100%)}
    .barTop{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .bar{
      height:10px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      overflow:hidden;
      margin-top:8px;
    }
    .bar > div{height:100%; width:0%}
  </style>

  <!-- jsPDF for PDF export -->
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>

<body>
<div class="wrap">
  <header>
    <div class="brand">
      <h1>Gold MCX Verdict</h1>
      <div class="sub" id="subtitle">Loading…</div>
    </div>
    <div class="top-actions">
      <button class="btn" id="btnReload">Reload CSV</button>
      <button class="btn" id="btnPdf">Export as PDF</button>
    </div>
  </header>

  <div class="grid">
    <!-- Latest -->
    <section class="panel" aria-label="Latest verdict">
      <div class="hd">
        <div class="t">Latest</div>
        <div class="meta" id="latestMeta">—</div>
      </div>
      <div class="bd">
        <div id="latestError" class="err" style="display:none"></div>

        <div class="big">
          <div class="verdict">
            <div class="label">Verdict</div>
            <div class="value" id="latestVerdict">—</div>

            <div class="pill" id="latestPill" style="margin-top:2px">
              <span class="dot warn" id="latestDot"></span>
              <span id="latestReason">—</span>
            </div>

            <div class="barWrap" aria-label="Confidence">
              <div class="barTop">
                <div class="muted">Confidence</div>
                <div style="font-weight:900" id="latestConf">—%</div>
              </div>
              <div class="bar"><div id="confBar"></div></div>
            </div>
          </div>

          <div style="min-width:240px; flex: 1; display:flex; justify-content:flex-end;">
            <div class="k" style="max-width:360px; width:100%">
              <div class="h">Key details</div>
              <div class="v small" id="latestDetails">—</div>
              <div class="kv" style="margin-top:12px">
                <div class="k">
                  <div class="h">Risk / Daily cap</div>
                  <div class="v" id="latestRisk">—</div>
                </div>
                <div class="k">
                  <div class="h">Capital (₹)</div>
                  <div class="v" id="latestCapital">—</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="foot" id="latestFoot"></div>
      </div>
    </section>

    <!-- All -->
    <section class="panel" aria-label="All records">
      <div class="hd">
        <div class="t">All records</div>
        <div class="meta"><span class="muted">Source:</span> <span id="sourceLabel">embedded</span></div>
      </div>
      <div class="bd">
        <div class="row">
          <input type="search" id="q" placeholder="Search (record_id, instrument, market, reason…)" />
          <div class="muted" id="countLabel">0 rows</div>
        </div>

        <div style="overflow:auto; border:1px solid var(--line); border-radius:14px">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Record</th>
                <th>Instrument</th>
                <th>Verdict</th>
                <th>Confidence</th>
                <th>Reason</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>

        <div class="foot">
          Create <code class="inline">verdict.csv</code> next to this <code class="inline">index.html</code> with columns:
          <code class="inline">record_id,date,capital_inr,market,instrument,mode,verdict,confidence_score_percent,bias_reason,risk_per_trade_inr,daily_loss_cap_inr</code>
        </div>
      </div>
    </section>
  </div>
</div>

<script>
/** ====== CONFIG ====== **/
const CSV_URL = "verdict.csv";
const EMBEDDED_CSV = `record_id,date,capital_inr,market,instrument,mode,verdict,confidence_score_percent,bias_reason,risk_per_trade_inr,daily_loss_cap_inr
MCXGOLD-20260220-V1,2026-02-20,35000,MCX,Gold Mini,Intraday,SELL,62,"Range resistance rejection probability higher than breakout probability",350,700`;

/** ====== CSV PARSER (handles quotes) ====== **/
function parseCSV(text){
  const rows = [];
  let i=0, field="", row=[], inQuotes=false;
  const pushField=()=>{ row.push(field); field=""; };
  const pushRow=()=>{ rows.push(row); row=[]; };

  while(i < text.length){
    const c = text[i];
    if(inQuotes){
      if(c === '"'){
        if(text[i+1] === '"'){ field += '"'; i++; }
        else { inQuotes = false; }
      } else field += c;
    } else {
      if(c === '"') inQuotes = true;
      else if(c === ',') pushField();
      else if(c === '\n'){
        pushField();
        if(row.length > 1 || row[0] !== "") pushRow();
      } else if(c !== '\r') field += c;
    }
    i++;
  }
  if(field.length || row.length){
    pushField();
    if(row.length > 1 || row[0] !== "") pushRow();
  }

  const header = (rows.shift() || []).map(h => (h||"").trim());
  return rows
    .filter(r => r.some(x => (x||"").trim() !== ""))
    .map(r => {
      const obj = {};
      header.forEach((h, idx)=> obj[h] = (r[idx] ?? "").trim());
      return obj;
    });
}

function safeNum(x){
  const n = Number(String(x||"").replace(/[^\d.-]/g,""));
  return Number.isFinite(n) ? n : null;
}
function fmtINR(n){
  if(n == null) return "—";
  try { return new Intl.NumberFormat("en-IN").format(n); }
  catch { return String(n); }
}
function verdictStyle(v){
  const vv = (v||"").toUpperCase();
  if(vv === "BUY" || vv === "GO") return {cls:"buy", dot:"ok", label: vv};
  if(vv === "SELL" || vv === "NO" || vv === "NO-GO") return {cls:"sell", dot:"bad", label: vv};
  return {cls:"hold", dot:"warn", label: vv || "—"};
}
function pickLatest(records){
  const toTime = (d)=> {
    const t = Date.parse(d);
    return Number.isFinite(t) ? t : -Infinity;
  };
  return [...records].sort((a,b)=>{
    const ta = toTime(a.date);
    const tb = toTime(b.date);
    if(tb !== ta) return tb - ta;
    return String(b.record_id||"").localeCompare(String(a.record_id||""));
  })[0] || null;
}

/** ====== STATE ====== **/
let STATE = { source:"embedded", records:[] };

/** ====== RENDER ====== **/
function render(){
  const {records, source} = STATE;
  document.getElementById("sourceLabel").textContent = source;

  const latest = pickLatest(records);
  if(!latest){
    setLatestError("No records found in CSV.");
    return;
  }
  clearLatestError();

  const vs = verdictStyle(latest.verdict);
  document.getElementById("latestVerdict").textContent = vs.label;
  document.getElementById("latestDot").className = `dot ${vs.dot}`;
  document.getElementById("latestReason").textContent = latest.bias_reason || "—";

  document.getElementById("latestMeta").textContent =
    `${latest.date || "—"} • ${latest.market || "—"} • ${latest.record_id || "—"}`;

  document.getElementById("subtitle").textContent =
    `Live verdict dashboard • latest update: ${latest.date || "—"}`;

  const conf = safeNum(latest.confidence_score_percent);
  document.getElementById("latestConf").textContent = (conf == null ? "—" : `${conf}%`);
  const bar = document.getElementById("confBar");
  const pct = Math.max(0, Math.min(100, conf ?? 0));
  bar.style.width = `${pct}%`;
  // match verdict to bar color
  bar.style.background = (vs.dot === "ok") ? "var(--ok)" : (vs.dot === "bad") ? "var(--bad)" : "var(--warn)";

  const cap = safeNum(latest.capital_inr);
  document.getElementById("latestCapital").textContent = cap == null ? "—" : `₹${fmtINR(cap)}`;

  const rpt = safeNum(latest.risk_per_trade_inr);
  const dlc = safeNum(latest.daily_loss_cap_inr);
  document.getElementById("latestRisk").textContent = `₹${fmtINR(rpt)} / ₹${fmtINR(dlc)}`;

  document.getElementById("latestDetails").textContent =
    `${latest.market || "—"} / ${latest.instrument || "—"} • ${latest.mode || "—"}`;

  document.getElementById("latestFoot").textContent =
    `Confidence is based on your score column (0–100). This page does not calculate signals; it only displays your CSV.`;

  renderTable(records);
}

function renderTable(records){
  const q = (document.getElementById("q").value || "").toLowerCase().trim();
  const tbody = document.getElementById("rows");
  tbody.innerHTML = "";

  const filtered = !q ? records : records.filter(r=>{
    const blob = Object.values(r).join(" ").toLowerCase();
    return blob.includes(q);
  });

  document.getElementById("countLabel").textContent = `${filtered.length} rows`;

  const sorted = [...filtered].sort((a,b)=>{
    const ta = Date.parse(a.date);
    const tb = Date.parse(b.date);
    return (Number.isFinite(tb)?tb:0) - (Number.isFinite(ta)?ta:0);
  });

  for(const r of sorted){
    const vs = verdictStyle(r.verdict);
    const conf = safeNum(r.confidence_score_percent);

    const tr = document.createElement("tr");

    const tdDate = document.createElement("td");
    tdDate.textContent = r.date || "—";

    const tdId = document.createElement("td");
    tdId.innerHTML = `<div style="font-weight:900">${esc(r.record_id||"—")}</div>
                      <div class="muted">₹${esc(r.capital_inr||"—")}</div>`;

    const tdInst = document.createElement("td");
    tdInst.innerHTML = `<div style="font-weight:900">${esc(r.market||"—")} / ${esc(r.instrument||"—")}</div>
                        <div class="muted">${esc(r.mode||"—")}</div>`;

    const tdVerd = document.createElement("td");
    tdVerd.innerHTML = `<span class="tag ${vs.cls}">
                          <span class="dot ${vs.dot}" style="width:8px;height:8px"></span>
                          ${esc(vs.label)}
                        </span>`;

    const tdConf = document.createElement("td");
    tdConf.textContent = conf == null ? "—" : `${conf}%`;

    const tdReason = document.createElement("td");
    tdReason.innerHTML = `<div style="font-weight:800">${esc(r.bias_reason||"—")}</div>
                          <div class="muted" style="margin-top:6px">Risk: ₹${esc(r.risk_per_trade_inr||"—")} • Cap: ₹${esc(r.daily_loss_cap_inr||"—")}</div>`;

    tr.append(tdDate, tdId, tdInst, tdVerd, tdConf, tdReason);
    tbody.appendChild(tr);
  }
}

function esc(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function setLatestError(msg){
  const el = document.getElementById("latestError");
  el.style.display = "block";
  el.textContent = msg;
}
function clearLatestError(){
  const el = document.getElementById("latestError");
  el.style.display = "none";
  el.textContent = "";
}

/** ====== LOAD ====== **/
async function loadCSV(){
  try{
    const res = await fetch(CSV_URL, {cache:"no-store"});
    if(res.ok){
      const text = await res.text();
      const records = parseCSV(text);
      STATE = { source: CSV_URL, records };
      return;
    }
    throw new Error("verdict.csv not found");
  }catch(e){
    const records = parseCSV(EMBEDDED_CSV);
    STATE = { source: "embedded", records };
  }
}

/** ====== PDF EXPORT ====== **/
function wrapLines(doc, text, x, y, maxWidth, lineHeight){
  const lines = doc.splitTextToSize(String(text || "—"), maxWidth);
  doc.text(lines, x, y);
  return y + (lines.length * lineHeight);
}

function exportLatestPDF(){
  const latest = pickLatest(STATE.records);
  if(!latest) return;

  const jsPDF = window.jspdf && window.jspdf.jsPDF;
  if(!jsPDF){
    window.print(); // fallback
    return;
  }

  const doc = new jsPDF({ unit: "pt", format: "a4" });
  const pageW = doc.internal.pageSize.getWidth();
  const margin = 40;
  const maxW = pageW - margin*2;
  let y = 48;

  doc.setFont("helvetica", "bold");
  doc.setFontSize(18);
  doc.text("Gold MCX Verdict Report", margin, y);
  y += 18;

  doc.setFont("helvetica", "normal");
  doc.setFontSize(11);
  doc.text(`Generated: ${new Date().toLocaleString()}`, margin, y);
  y += 18;

  doc.setFont("helvetica", "bold"); doc.setFontSize(12);
  doc.text(`Verdict: ${(latest.verdict || "—").toUpperCase()}`, margin, y);
  y += 16;

  doc.setFont("helvetica", "normal"); doc.setFontSize(11);
  y = wrapLines(doc, `Record ID: ${latest.record_id || "—"}`, margin, y, maxW, 14);
  y = wrapLines(doc, `Date: ${latest.date || "—"}`, margin, y, maxW, 14);
  y = wrapLines(doc, `Market: ${latest.market || "—"}   Instrument: ${latest.instrument || "—"}`, margin, y, maxW, 14);
  y = wrapLines(doc, `Mode: ${latest.mode || "—"}   Capital (INR): ${latest.capital_inr || "—"}`, margin, y, maxW, 14);
  y = wrapLines(doc, `Confidence: ${latest.confidence_score_percent || "—"}%`, margin, y, maxW, 14);
  y = wrapLines(doc, `Bias reason: ${latest.bias_reason || "—"}`, margin, y, maxW, 14);
  y = wrapLines(doc, `Risk/trade: ${latest.risk_per_trade_inr || "—"}   Daily cap: ${latest.daily_loss_cap_inr || "—"}`, margin, y, maxW, 14);

  const fname = `${latest.record_id || "latest"}-verdict.pdf`;
  doc.save(fname);
}

/** ====== INIT ====== **/
document.getElementById("q").addEventListener("input", ()=> renderTable(STATE.records));
document.getElementById("btnReload").addEventListener("click", async ()=>{
  document.getElementById("subtitle").textContent = "Reloading…";
  await boot();
});
document.getElementById("btnPdf").addEventListener("click", exportLatestPDF);

async function boot(){
  await loadCSV();
  render();
}
boot();
</script>
</body>
</html>
