<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Live Commodity Dashboard</title>
  <style>
    :root { color-scheme: dark; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 800px at 20% 0%, rgba(72, 61, 255, 0.20), transparent 60%),
                  radial-gradient(900px 600px at 90% 10%, rgba(0, 212, 255, 0.16), transparent 55%),
                  #0b0f14;
      color: #e6edf3;
    }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 22px; }
    header {
      display: flex; align-items: baseline; justify-content: space-between;
      gap: 16px; margin-bottom: 14px;
    }
    h1 { margin: 0; font-size: 18px; letter-spacing: 0.2px; }
    .sub { margin: 6px 0 0; color: #9aa7b2; font-size: 12px; line-height: 1.4; }
    .status {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 8px 10px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.22);
      font-size: 12px; color: #cdd9e5; white-space: nowrap;
    }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: #7ee787; box-shadow: 0 0 0 3px rgba(126,231,135,0.12); }
    .dot.off { background: #ff7b72; box-shadow: 0 0 0 3px rgba(255,123,114,0.12); }
    .card {
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.03);
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      overflow: hidden;
    }
    .cardTop {
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      display: flex; flex-wrap: wrap; gap: 10px 16px;
      align-items: center; justify-content: space-between;
    }
    .meta { display: flex; gap: 12px; flex-wrap: wrap; color: #9aa7b2; font-size: 12px; }
    .pill {
      display: inline-flex; align-items: center;
      padding: 6px 10px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.22);
      gap: 8px;
    }
    .btn {
      cursor: pointer;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color: #e6edf3;
      padding: 6px 10px;
      font-size: 12px;
    }
    .btn:hover { background: rgba(255,255,255,0.10); }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px 14px; border-bottom: 1px solid rgba(255,255,255,0.06); text-align: left; font-size: 13px; }
    th { color: #a9b6c2; font-weight: 650; font-size: 12px; letter-spacing: 0.2px; }
    tr:hover td { background: rgba(255,255,255,0.03); }
    .num { font-variant-numeric: tabular-nums; }
    .deltaPos { color: #7ee787; }
    .deltaNeg { color: #ff7b72; }
    .deltaZero { color: #9aa7b2; }
    .foot {
      padding: 12px 14px; color: #9aa7b2; font-size: 12px;
      display: flex; flex-wrap: wrap; gap: 10px 16px;
      align-items: center; justify-content: space-between;
    }
    code {
      padding: 2px 6px; border-radius: 8px;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.07);
      color: #dbe7f3;
    }
    .errBox{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,123,114,0.25);
      background: rgba(255,123,114,0.08);
      color:#ffd6d3;
      font-size: 12px;
      display:none;
      white-space: pre-wrap;
      word-break: break-word;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Live Commodity Dashboard</h1>
        <div class="sub">Polling <code id="apiLabel"></code> every <span class="num" id="pollMs"></span>ms.</div>
      </div>
      <div class="status">
        <span class="dot off" id="dot"></span>
        <span id="statusText">offline</span>
      </div>
    </header>

    <section class="card">
      <div class="cardTop">
        <div class="meta">
          <span class="pill">Frontend poll: <span class="num" id="pollMs2"></span>ms</span>
          <span class="pill">Provider refresh: <span class="num" id="provMs">—</span>ms</span>
          <span class="pill">Last data ts: <span class="num" id="lastUpdate">—</span></span>
        </div>
        <div class="meta">
          <button class="btn" id="btnTest">Test API</button>
          <button class="btn" id="btnRefresh">Refresh Now</button>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Commodity</th>
            <th>Price</th>
            <th>Delta</th>
            <th>Unit</th>
            <th>Source</th>
            <th>Updated</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>

      <div class="foot">
        <div>Backend: <code id="backendLabel"></code></div>
        <div class="num" id="health">—</div>
      </div>

      <div class="errBox" id="errBox"></div>
    </section>
  </div>

  <script>
    // ✅ If you serve this from the same Express server, you can also use:
    // const API_URL = '/prices';
    const API_URL = 'http://127.0.0.1:3000/prices';
    const POLL_MS = 1000;
    const LIVE_WINDOW_MS = 3500; // UI shows live if we got OK within this window

    const instrumentsOrder = [
      { key: 'gold',   label: 'Gold' },
      { key: 'silver', label: 'Silver' },
      { key: 'copper', label: 'Copper' },
      { key: 'zinc',   label: 'Zinc' },
      { key: 'crude',  label: 'Crude Oil (WTI)' }
    ];

    const prevPriceByKey = Object.create(null);
    let lastOkAt = 0;

    const elRows = document.getElementById('rows');
    const elDot = document.getElementById('dot');
    const elStatusText = document.getElementById('statusText');
    const elHealth = document.getElementById('health');
    const elProvMs = document.getElementById('provMs');
    const elLastUpdate = document.getElementById('lastUpdate');
    const elErrBox = document.getElementById('errBox');

    document.getElementById('pollMs').textContent = String(POLL_MS);
    document.getElementById('pollMs2').textContent = String(POLL_MS);
    document.getElementById('apiLabel').textContent = API_URL;
    document.getElementById('backendLabel').textContent = '127.0.0.1:3000';

    function fmtMoney(x) {
      if (typeof x !== 'number' || !Number.isFinite(x)) return '—';
      return x.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function fmtDelta(d) {
      if (typeof d !== 'number' || !Number.isFinite(d)) return { text: '—', cls: 'deltaZero' };
      if (d > 0) return { text: '+' + fmtMoney(d), cls: 'deltaPos' };
      if (d < 0) return { text: '-' + fmtMoney(Math.abs(d)), cls: 'deltaNeg' };
      return { text: '0.00', cls: 'deltaZero' };
    }

    function setStatus(live) {
      if (live) {
        elDot.classList.remove('off');
        elStatusText.textContent = 'live';
      } else {
        elDot.classList.add('off');
        elStatusText.textContent = 'offline';
      }
    }

    function toLocal(isoOrMs) {
      if (!isoOrMs) return '—';
      const d = typeof isoOrMs === 'number' ? new Date(isoOrMs) : new Date(isoOrMs);
      if (Number.isNaN(d.getTime())) return '—';
      return d.toLocaleString();
    }

    function showErr(msg) {
      if (!msg) { elErrBox.style.display = 'none'; elErrBox.textContent = ''; return; }
      elErrBox.style.display = 'block';
      elErrBox.textContent = String(msg);
    }

    function render(payload) {
      // Accept multiple backend shapes:
      // Shape A (recommended): { ok, providerRefreshMs, err, data: { instruments: {...}}}
      const ok = !!(payload && payload.ok);
      const providerRefreshMs = payload && typeof payload.providerRefreshMs === 'number' ? payload.providerRefreshMs : null;
      const err = payload && payload.err ? payload.err : null;

      if (providerRefreshMs != null) elProvMs.textContent = String(providerRefreshMs);

      if (ok) lastOkAt = Date.now();
      setStatus((Date.now() - lastOkAt) <= LIVE_WINDOW_MS);

      const instruments = payload?.data?.instruments || {};
      let newest = null;

      const rows = instrumentsOrder.map(({key,label}) => {
        const v = instruments[key] || {};
        const price = (typeof v.price === 'number' && Number.isFinite(v.price)) ? v.price : null;

        const prev = prevPriceByKey[key];
        const delta = (price !== null && typeof prev === 'number') ? (price - prev) : null;
        if (price !== null) prevPriceByKey[key] = price;

        // accept updated or ts
        const updated = v.updated || v.ts || null;
        if (updated) {
          const t = new Date(updated).getTime();
          if (!Number.isNaN(t) && (newest === null || t > newest)) newest = t;
        }

        const dObj = fmtDelta(delta);
        return `
          <tr>
            <td>${label}</td>
            <td class="num">${price === null ? '—' : fmtMoney(price)}</td>
            <td class="num ${dObj.cls}">${dObj.text}</td>
            <td>${v.unit || '—'}</td>
            <td>${v.source || '—'}</td>
            <td class="num">${toLocal(updated)}</td>
          </tr>
        `;
      });

      elRows.innerHTML = rows.join('');
      elLastUpdate.textContent = newest ? toLocal(newest) : '—';

      // Health text
      if (ok) {
        elHealth.textContent = 'OK';
        showErr(null);
      } else {
        // If fetch succeeded but provider failed, show provider error
        elHealth.textContent = 'Backend reachable, provider error';
        showErr(err || 'Unknown backend/provider error');
      }
    }

    async function fetchWithTimeout(url, ms) {
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort(), ms);
      try {
        const resp = await fetch(url, { cache: 'no-store', signal: ctrl.signal });
        const text = await resp.text();

        // show HTTP errors clearly
        if (!resp.ok) throw new Error(`HTTP ${resp.status}: ${text.slice(0, 200)}`);

        try {
          return JSON.parse(text);
        } catch {
          throw new Error(`Not JSON from backend. First 200 chars: ${text.slice(0,200)}`);
        }
      } finally {
        clearTimeout(t);
      }
    }

    async function tick() {
      try {
        const json = await fetchWithTimeout(API_URL, 8000);
        render(json);
      } catch (e) {
        setStatus(false);
        elHealth.textContent = 'Fetch failed (server down / blocked / CORS)';
        showErr(e.message || String(e));
        // keep table with blanks
        render({ ok: false, err: e.message, data: { instruments: {} } });
      } finally {
        setTimeout(tick, POLL_MS);
      }
    }

    document.getElementById('btnRefresh').addEventListener('click', async () => {
      try {
        const json = await fetchWithTimeout(API_URL, 8000);
        render(json);
      } catch (e) {
        setStatus(false);
        elHealth.textContent = 'Fetch failed';
        showErr(e.message || String(e));
      }
    });

    document.getElementById('btnTest').addEventListener('click', async () => {
      showErr(null);
      elHealth.textContent = 'Testing...';
      try {
        const json = await fetchWithTimeout(API_URL, 8000);
        elHealth.textContent = 'API OK (JSON received)';
        render(json);
      } catch (e) {
        elHealth.textContent = 'API FAIL';
        showErr(e.message || String(e));
      }
    });

    // boot
    render({ ok:false, data:{ instruments:{} }});
    tick();
  </script>
</body>
</html>
