
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Commodity Verdict</title>
<meta name="theme-color" content="#0b0f14" />

<style>
:root{
  color-scheme:dark;
  --bg:#0b0f14;
  --text:#e6edf3;
  --muted:#9fb0c3;
  --line:rgba(255,255,255,.08);
  --ok:#2fe67a;
  --warn:#ffd24a;
  --bad:#ff5c7a;
  --shadow: 0 10px 30px rgba(0,0,0,.35);
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,Segoe UI,Roboto,Arial;
  background:
    radial-gradient(1000px 700px at 20% 0%,rgba(72,61,255,.15),transparent 60%),
    radial-gradient(900px 600px at 90% 10%,rgba(0,212,255,.10),transparent 55%),
    var(--bg);
  color:var(--text);
  padding:24px;
}
.wrap{max-width:1000px;margin:auto}
header{
  display:flex;justify-content:space-between;align-items:center;
  margin-bottom:16px;gap:12px;flex-wrap:wrap
}
h1{margin:0;font-size:22px}
.sub{color:var(--muted);font-size:13px;line-height:1.35}
.btn{
  border:1px solid var(--line);
  background:rgba(255,255,255,.05);
  color:var(--text);
  padding:9px 12px;border-radius:12px;
  cursor:pointer;font-weight:900;font-size:13px
}
.btn:hover{background:rgba(255,255,255,.08)}

.panel{
  border:1px solid var(--line);
  border-radius:16px;
  background:rgba(255,255,255,.02);
  box-shadow:var(--shadow);
  margin-bottom:14px;
  overflow:hidden
}
.panel .hd{
  padding:12px 14px;
  border-bottom:1px solid var(--line);
  font-weight:950;
  display:flex;justify-content:space-between;align-items:center;
  gap:10px;flex-wrap:wrap
}
.panel .bd{padding:14px}

.verdict{font-size:44px;font-weight:1000;letter-spacing:.3px}
.pill{
  display:inline-flex;align-items:center;gap:8px;
  padding:7px 10px;border-radius:999px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.03);
  font-weight:950;font-size:12px;
  margin-top:10px
}
.dot{width:10px;height:10px;border-radius:50%}
.ok{background:var(--ok)}
.warn{background:var(--warn)}
.bad{background:var(--bad)}

.bar{
  height:10px;border-radius:999px;
  background:rgba(255,255,255,.05);
  margin-top:6px;
  overflow:hidden;
  border:1px solid var(--line)
}
.bar>div{height:100%;border-radius:999px;width:0%}

.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
@media(max-width:700px){.grid{grid-template-columns:1fr}}
.k{border:1px solid var(--line);border-radius:12px;padding:10px;background:rgba(255,255,255,.02)}
.k .h{font-size:12px;color:var(--muted);margin-bottom:6px}
.k .v{font-weight:1000}
.k .v.small{font-weight:850;color:var(--text);opacity:.92;font-size:13px;line-height:1.35}
.k .v.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}

.filters{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
.filter{
  padding:8px 12px;border-radius:999px;
  border:1px solid var(--line);
  cursor:pointer;font-size:12px;font-weight:1000;
  background:rgba(255,255,255,.03)
}
.filter.active{background:rgba(255,255,255,.10)}

table{width:100%;border-collapse:collapse;font-size:12px}
th,td{padding:10px 8px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
th{color:var(--muted);font-weight:950;background:rgba(0,0,0,.12)}
tr:hover td{background:rgba(255,255,255,.02)}

.empty{
  text-align:center;
  padding:34px 10px;
  color:var(--muted);
  font-weight:900;
}

.inputRow{
  display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px
}
.input, select{
  border:1px solid var(--line);
  background:rgba(0,0,0,.22);
  color:var(--text);
  padding:10px 12px;border-radius:12px;
  outline:none;
  font-weight:900
}
.input{flex:1;min-width:180px}
select{min-width:160px}
.smallNote{color:var(--muted);font-size:12px;margin-top:8px;line-height:1.35}

/* Terms banner */
.termsBanner{
  border:1px solid rgba(255,255,255,.08);
  background:rgba(255,255,255,.03);
  border-radius:14px;
  padding:12px 14px;
  margin-bottom:14px;
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:space-between;
  flex-wrap:wrap;
}
</style>

<script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>

<body>
<div class="wrap">
  <header>
    <div>
      <h1>Commodity Verdict</h1>
      <div class="sub" id="subtitle">Loading…</div>
    </div>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn" id="btnReload">Reload</button>
      <button class="btn" id="btnPdf">Export PDF</button>
    </div>
  </header>

  <!-- TERMS CTA -->
  <section id="termsBanner" class="termsBanner">
    <div style="font-size:13px;color:#9fb0c3;font-weight:800;line-height:1.35">
      This dashboard shows <b>verdicts / recommendations only</b>.
      It is <b>not a trading call</b> and <b>does not guarantee profit</b>.
    </div>
    <button id="openTerms" class="btn">View Terms</button>
  </section>

  <!-- Latest -->
  <section class="panel">
    <div class="hd">
      <div>Latest</div>
      <div class="sub">Source: <span id="sourceLabel">—</span></div>
    </div>

    <div class="bd">
      <div id="latestEmpty" class="empty" style="display:none">No data available</div>

      <div id="latestBlock" style="display:none">
        <div class="verdict" id="latestVerdict">—</div>

        <div class="pill">
          <span class="dot warn" id="latestDot"></span>
          <span id="latestMeta">—</span>
        </div>

        <div style="margin-top:12px">
          <div class="sub">Confidence <b id="latestConf">—%</b></div>
          <div class="bar"><div id="confBar"></div></div>
        </div>

        <!-- Live price input (commodity-aware) -->
        <div class="k" style="margin-top:12px">
          <div class="h">Live price input</div>
          <div class="inputRow">
            <select id="liveCommodity" aria-label="Commodity">
              <option value="GOLD">Gold</option>
              <option value="SILVER">Silver</option>
              <option value="CRUDE">Crude</option>
              <option value="ZINC">Zinc</option>
              <option value="COPPER">Copper</option>
            </select>
            <input id="livePrice" class="input" inputmode="decimal" placeholder="Enter live price (LTP)" />
            <button class="btn" id="btnCalc">Calculate</button>
          </div>
          <div class="smallNote">
            Select commodity + enter live price. Verdict/confidence updates using that commodity’s latest CSV row.
            JSON saved to <span class="v mono">localStorage: LIVE_VERDICT_JSON</span>.
          </div>
          <div id="calcMsg" class="smallNote"></div>
        </div>

        <div class="grid">
          <div class="k"><div class="h">Instrument</div><div class="v" id="latestInst">—</div></div>
          <div class="k"><div class="h">LTP</div><div class="v" id="latestLtp">—</div></div>

          <div class="k"><div class="h">Entry zone</div><div class="v small" id="latestEntry">—</div></div>
          <div class="k"><div class="h">Invalid if above</div><div class="v" id="latestInvalid">—</div></div>

          <div class="k"><div class="h">Capital</div><div class="v" id="latestCap">—</div></div>
          <div class="k"><div class="h">Risk / Daily cap</div><div class="v" id="latestRisk">—</div></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Records -->
  <section class="panel">
    <div class="hd"><div>Records</div></div>
    <div class="bd">
      <div class="filters" id="filters">
        <div class="filter active" data-key="ALL">All</div>
        <div class="filter" data-key="GOLD">Gold</div>
        <div class="filter" data-key="SILVER">Silver</div>
        <div class="filter" data-key="CRUDE">Crude</div>
        <div class="filter" data-key="ZINC">Zinc</div>
        <div class="filter" data-key="COPPER">Copper</div>
      </div>

      <div id="tableWrap" style="overflow:auto;border:1px solid var(--line);border-radius:14px">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Record</th>
              <th>Instrument</th>
              <th>LTP</th>
              <th>Verdict</th>
              <th>Conf</th>
              <th>Entry</th>
              <th>Invalid</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>

      <div id="tableEmpty" class="empty" style="display:none">No data available</div>
    </div>
  </section>
</div>

<!-- TERMS MODAL -->
<div id="termsModal" style="
position:fixed;
inset:0;
background:rgba(0,0,0,.7);
display:none;
align-items:center;
justify-content:center;
z-index:9999;
padding:20px;">
  <div style="
  max-width:520px;
  width:100%;
  background:#0f1722;
  border:1px solid rgba(255,255,255,.08);
  border-radius:16px;
  padding:20px;">
    <h3 style="margin-top:0">Terms & Disclaimer</h3>
    <p style="font-size:13px;color:#9fb0c3;line-height:1.5;margin-bottom:0">
      • This dashboard provides <b>informational verdicts and trade ideas only</b>.<br><br>
      • It is <b>NOT financial advice</b> and <b>NOT a trading call</b>.<br><br>
      • No guarantees of profit, performance, or accuracy are made.<br><br>
      • Markets involve risk. You are solely responsible for your trades and capital.<br><br>
      • Always verify with your broker, risk plan, and personal judgment before acting.
    </p>

    <div style="display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;margin-top:14px">
      <button id="closeTerms" class="btn">Close</button>
      <button id="acceptTerms" class="btn">I Understand</button>
    </div>
  </div>
</div>

<script>
/** ====== SETTINGS ====== **/
const LS_CSV_KEY = "VERDICT_CSV";         // written by admin.html
const LS_CSV_TS  = "VERDICT_CSV_TS";
const LS_LIVE_JSON = "LIVE_VERDICT_JSON"; // generated JSON stored here
const TERMS_KEY = "TERMS_ACCEPTED_V1";
const CSV_URL = "verdict.csv";

/** Embedded fallback */
const EMBEDDED = `record_id,date,ltp,capital_inr,market,instrument,mode,verdict,confidence_score_percent,entry_zone,invalid_if_above,risk_per_trade_inr,daily_loss_cap_inr
MCXGOLD-20260220-V2,2026-02-20,154700,35000,MCX,Gold Futures (02APR2026),Intraday,SELL,68,"Below 154600 breakdown","155200",350,700`;

/** ====== TERMS ====== **/
const modal=document.getElementById("termsModal");
document.getElementById("openTerms").onclick=()=>modal.style.display="flex";
document.getElementById("closeTerms").onclick=()=>modal.style.display="none";
document.getElementById("acceptTerms").onclick=()=>{ localStorage.setItem(TERMS_KEY,"1"); modal.style.display="none"; };
if(!localStorage.getItem(TERMS_KEY)) modal.style.display="flex";

/** ====== CSV PARSER ====== **/
function parseCSV(text){
  const rows=[]; let i=0, f="", row=[], q=false;
  const pf=()=>{ row.push(f); f=""; };
  const pr=()=>{ rows.push(row); row=[]; };
  while(i<text.length){
    const c=text[i];
    if(q){
      if(c==='"'){ if(text[i+1]==='"'){ f+='"'; i++; } else q=false; }
      else f+=c;
    } else {
      if(c==='"') q=true;
      else if(c===',') pf();
      else if(c==='\n'){ pf(); if(row.length>1 || (row[0]||"").trim()!=="") pr(); }
      else if(c!=='\r') f+=c;
    }
    i++;
  }
  if(f.length || row.length){ pf(); if(row.length>1 || (row[0]||"").trim()!=="") pr(); }
  const header=(rows.shift()||[]).map(x=>String(x||"").trim());
  return rows.filter(r=>r.some(x=>String(x||"").trim()!=="")).map(r=>{
    const o={}; header.forEach((h,idx)=> o[h]=String(r[idx]??"").trim()); return o;
  });
}
function safeNum(x){
  const n=Number(String(x||"").replace(/[^\d.-]/g,""));
  return Number.isFinite(n) ? n : null;
}
function fmtINR(n){
  if(n==null) return "—";
  try { return new Intl.NumberFormat("en-IN").format(n); } catch { return String(n); }
}
function verdictDot(v){
  v=(v||"").toUpperCase();
  if(v==="BUY") return "ok";
  if(v==="SELL") return "bad";
  return "warn";
}
function pickLatest(records){
  const toT=(d)=>{ const t=Date.parse(d); return Number.isFinite(t)?t:-Infinity; };
  return [...records].sort((a,b)=>{
    const ta=toT(a.date), tb=toT(b.date);
    if(tb!==ta) return tb-ta;
    return String(b.record_id||"").localeCompare(String(a.record_id||""));
  })[0]||null;
}
function commodityKeyFromInstrument(inst){
  const s=String(inst||"").toUpperCase();
  if(s.includes("GOLD")) return "GOLD";
  if(s.includes("SILVER")) return "SILVER";
  if(s.includes("CRUDE")) return "CRUDE";
  if(s.includes("ZINC")) return "ZINC";
  if(s.includes("COPPER")) return "COPPER";
  return "OTHER";
}
function esc(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/** ====== LIVE VERDICT LOGIC (same as gold version) ====== **/
function extractFirstNumber(s){
  const m = String(s||"").replace(/,/g,"").match(/(-?\d+(\.\d+)?)/);
  return m ? Number(m[1]) : null;
}
function computeLiveUpdate(row, livePrice){
  const baseConf = Math.max(0, Math.min(100, safeNum(row.confidence_score_percent) ?? 0));
  const invalidAbove = extractFirstNumber(row.invalid_if_above);
  const entryText = String(row.entry_zone||"").toLowerCase();
  const entryNum = extractFirstNumber(row.entry_zone);

  let verdict = (row.verdict||"HOLD").toUpperCase();
  let conf = baseConf;
  let reason = "Based on CSV template";

  if(invalidAbove != null && livePrice > invalidAbove){
    verdict = "HOLD";
    conf = Math.max(10, Math.min(35, baseConf * 0.5));
    reason = `Invalidated: live price (${livePrice}) > invalid_if_above (${invalidAbove})`;
    return { verdict, conf, reason, invalidated:true };
  }

  const isBelow = entryText.includes("below");
  const isAbove = entryText.includes("above");

  if(entryNum != null && isBelow){
    if(livePrice < entryNum){
      verdict = "SELL";
      const dist = Math.min(1, Math.max(0, (entryNum - livePrice) / Math.max(1, entryNum*0.01)));
      conf = Math.max(baseConf, Math.min(95, baseConf + dist*20));
      reason = `Trigger: price (${livePrice}) below entry threshold (${entryNum})`;
    }else{
      verdict = "HOLD";
      conf = Math.max(15, Math.min(55, baseConf * 0.7));
      reason = `No trigger: price (${livePrice}) not below entry threshold (${entryNum})`;
    }
  } else if(entryNum != null && isAbove){
    if(livePrice > entryNum){
      verdict = "BUY";
      const dist = Math.min(1, Math.max(0, (livePrice - entryNum) / Math.max(1, entryNum*0.01)));
      conf = Math.max(baseConf, Math.min(95, baseConf + dist*20));
      reason = `Trigger: price (${livePrice}) above entry threshold (${entryNum})`;
    }else{
      verdict = "HOLD";
      conf = Math.max(15, Math.min(55, baseConf * 0.7));
      reason = `No trigger: price (${livePrice}) not above entry threshold (${entryNum})`;
    }
  } else {
    verdict = (row.verdict||"HOLD").toUpperCase();
    if(invalidAbove != null){
      const headroom = Math.max(0, invalidAbove - livePrice);
      const factor = Math.min(1, headroom / Math.max(1, invalidAbove*0.01));
      conf = Math.max(10, Math.min(90, baseConf * (0.7 + factor*0.3)));
      reason = `Fallback: entry_zone not parseable; using CSV verdict`;
    } else {
      conf = baseConf;
      reason = `Fallback: using CSV verdict`;
    }
  }

  return { verdict, conf, reason, invalidated:false };
}

/** ====== STATE ====== **/
let STATE = { source:"—", records:[], filter:"ALL" };

/** ====== RENDER ====== **/
function render(){
  const all = STATE.records || [];
  const filtered = all.filter(r=>{
    if(STATE.filter==="ALL") return true;
    return commodityKeyFromInstrument(r.instrument) === STATE.filter;
  });

  document.getElementById("sourceLabel").textContent = STATE.source;

  const latest = pickLatest(filtered);
  if(!latest){
    document.getElementById("latestBlock").style.display="none";
    document.getElementById("latestEmpty").style.display="block";
    document.getElementById("tableWrap").style.display="none";
    document.getElementById("tableEmpty").style.display="block";
    return;
  }

  document.getElementById("latestEmpty").style.display="none";
  document.getElementById("latestBlock").style.display="block";

  document.getElementById("subtitle").textContent = `Latest update: ${latest.date || "—"}`;
  document.getElementById("latestVerdict").textContent = (latest.verdict||"—").toUpperCase();
  document.getElementById("latestDot").className = `dot ${verdictDot(latest.verdict)}`;

  const ltp = safeNum(latest.ltp);
  const cap = safeNum(latest.capital_inr);
  const rpt = safeNum(latest.risk_per_trade_inr);
  const dlc = safeNum(latest.daily_loss_cap_inr);
  const conf = Math.max(0, Math.min(100, safeNum(latest.confidence_score_percent) ?? 0));

  document.getElementById("latestMeta").textContent = `${latest.market||"—"} • ${latest.mode||"—"} • ${latest.record_id||"—"}`;
  document.getElementById("latestInst").textContent = `${latest.market||"—"} / ${latest.instrument||"—"}`;
  document.getElementById("latestLtp").textContent = ltp==null ? "—" : `₹${fmtINR(ltp)}`;
  document.getElementById("latestEntry").textContent = latest.entry_zone || "—";
  document.getElementById("latestInvalid").textContent = latest.invalid_if_above || "—";
  document.getElementById("latestCap").textContent = cap==null ? "—" : `₹${fmtINR(cap)}`;
  document.getElementById("latestRisk").textContent = `₹${fmtINR(rpt)} / ₹${fmtINR(dlc)}`;

  document.getElementById("latestConf").textContent = `${conf}%`;
  const bar = document.getElementById("confBar");
  bar.style.width = `${conf}%`;
  bar.style.background = (verdictDot(latest.verdict)==="bad") ? "var(--bad)" : (verdictDot(latest.verdict)==="ok") ? "var(--ok)" : "var(--warn)";

  // sync live commodity dropdown to current filter (if not ALL)
  const lc = document.getElementById("liveCommodity");
  if(STATE.filter !== "ALL") lc.value = STATE.filter;

  // table
  const tbody=document.getElementById("rows");
  tbody.innerHTML="";
  document.getElementById("tableEmpty").style.display="none";
  document.getElementById("tableWrap").style.display="block";

  const sorted=[...filtered].sort((a,b)=>{
    const ta=Date.parse(a.date), tb=Date.parse(b.date);
    return (Number.isFinite(tb)?tb:0) - (Number.isFinite(ta)?ta:0);
  });

  for(const r of sorted){
    const conf2 = safeNum(r.confidence_score_percent);
    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td>${esc(r.date||"—")}</td>
      <td><b>${esc(r.record_id||"—")}</b></td>
      <td>${esc(r.market||"—")} / ${esc(r.instrument||"—")}<div class="sub">${esc(r.mode||"—")}</div></td>
      <td>${r.ltp ? ("₹"+esc(r.ltp)) : "—"}</td>
      <td><span class="dot ${verdictDot(r.verdict)}"></span>${esc((r.verdict||"—").toUpperCase())}</td>
      <td>${conf2==null ? "—" : esc(conf2)+"%"}</td>
      <td>${esc(r.entry_zone||"—")}</td>
      <td>${esc(r.invalid_if_above||"—")}</td>
    `;
    tbody.appendChild(tr);
  }

  document.getElementById("calcMsg").textContent = "";
}

/** ====== LOAD ORDER: localStorage(admin) -> verdict.csv -> embedded ====== **/
async function loadData(){
  const ls = localStorage.getItem(LS_CSV_KEY);
  if(ls && ls.trim().length>10){
    const ts = localStorage.getItem(LS_CSV_TS);
    let suffix = "";
    if(ts){
      const d = new Date(Number(ts));
      suffix = isNaN(d.getTime()) ? "" : ` • saved ${d.toLocaleString()}`;
    }
    STATE.source = `localStorage (admin)${suffix}`;
    STATE.records = parseCSV(ls.trim());
    return;
  }
  try{
    const res = await fetch(CSV_URL, {cache:"no-store"});
    if(!res.ok) throw new Error("no verdict.csv");
    const text = await res.text();
    STATE.source = CSV_URL;
    STATE.records = parseCSV(text);
  }catch{
    STATE.source = "embedded";
    STATE.records = parseCSV(EMBEDDED);
  }
}

/** ====== BACKEND POST (optional) ====== **/
async function postLiveToBackend(payload){
  try{
    const res = await fetch("/api/live", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    if(!res.ok) throw new Error("backend not ok");
    return await res.json().catch(()=>({ok:true}));
  }catch{
    return null;
  }
}

/** ====== COMMODITY-AWARE LIVE CALC ====== **/
async function onCalculate(){
  const liveCommodity = document.getElementById("liveCommodity").value; // GOLD/SILVER/...
  const v = safeNum(document.getElementById("livePrice").value);
  if(v == null || v <= 0){
    document.getElementById("calcMsg").textContent = "Enter a valid live price.";
    return;
  }

  // use latest row from selected commodity (not current filter)
  const forCommodity = (STATE.records || []).filter(r => commodityKeyFromInstrument(r.instrument) === liveCommodity);
  const row = pickLatest(forCommodity);

  if(!row){
    document.getElementById("calcMsg").textContent = `No data available for ${liveCommodity}.`;
    return;
  }

  const live = computeLiveUpdate(row, v);

  const json = {
    type: "live_verdict_update",
    ts: Date.now(),
    date: new Date().toISOString(),
    commodity: liveCommodity,
    record_id: row.record_id || null,
    market: row.market || null,
    instrument: row.instrument || null,
    mode: row.mode || null,
    csv_ltp: safeNum(row.ltp),
    live_ltp: v,
    entry_zone: row.entry_zone || null,
    invalid_if_above: row.invalid_if_above || null,
    verdict_prev: (row.verdict||"").toUpperCase(),
    confidence_prev: safeNum(row.confidence_score_percent),
    verdict_live: live.verdict,
    confidence_live: Math.round(live.conf*10)/10,
    reason_live: live.reason,
    invalidated: !!live.invalidated
  };

  localStorage.setItem(LS_LIVE_JSON, JSON.stringify(json, null, 2));
  const backendResp = await postLiveToBackend(json);

  // reflect live result into that commodity's latest row in-memory (and UI if you're viewing it)
  row.ltp = String(v);
  row.verdict = live.verdict;
  row.confidence_score_percent = String(Math.round(live.conf*10)/10);

  render();

  document.getElementById("calcMsg").textContent =
    backendResp
      ? `Updated ${liveCommodity}. Saved locally + backend OK.`
      : `Updated ${liveCommodity}. Saved locally. (Backend /api/live not available.)`;
}

/** ====== PDF EXPORT (current filter latest) ====== **/
function wrap(doc, text, x, y, maxW){
  const lines = doc.splitTextToSize(String(text||"—"), maxW);
  doc.text(lines, x, y);
  return y + (lines.length * 14);
}
function exportPDF(){
  const all = STATE.records || [];
  const filtered = all.filter(r=>{
    if(STATE.filter==="ALL") return true;
    return commodityKeyFromInstrument(r.instrument) === STATE.filter;
  });
  const latest = pickLatest(filtered);
  if(!latest){
    alert("No data available for this filter.");
    return;
  }

  const jsPDF = window.jspdf && window.jspdf.jsPDF;
  if(!jsPDF){ window.print(); return; }

  const doc = new jsPDF({unit:"pt", format:"a4"});
  const margin=40, maxW=515;
  let y=48;

  doc.setFont("helvetica","bold"); doc.setFontSize(18);
  doc.text("Commodity Verdict Report", margin, y); y+=18;

  doc.setFont("helvetica","normal"); doc.setFontSize(11);
  doc.text(`Generated: ${new Date().toLocaleString()}`, margin, y); y+=18;

  doc.setFont("helvetica","bold"); doc.setFontSize(12);
  doc.text(`Verdict: ${(latest.verdict||"—").toUpperCase()}   Confidence: ${latest.confidence_score_percent||"—"}%`, margin, y); y+=16;

  doc.setFont("helvetica","normal"); doc.setFontSize(11);
  y = wrap(doc, `Record: ${latest.record_id||"—"}   Date: ${latest.date||"—"}`, margin, y, maxW);
  y = wrap(doc, `Market/Instrument: ${latest.market||"—"} / ${latest.instrument||"—"}`, margin, y, maxW);
  y = wrap(doc, `Mode: ${latest.mode||"—"}   LTP: ${latest.ltp||"—"}   Capital: ${latest.capital_inr||"—"}`, margin, y, maxW);
  y = wrap(doc, `Entry zone: ${latest.entry_zone||"—"}`, margin, y, maxW);
  y = wrap(doc, `Invalid if above: ${latest.invalid_if_above||"—"}`, margin, y, maxW);
  y = wrap(doc, `Risk/trade: ${latest.risk_per_trade_inr||"—"}   Daily cap: ${latest.daily_loss_cap_inr||"—"}`, margin, y, maxW);

  doc.save(`${latest.record_id||"latest"}-verdict.pdf`);
}

/** ====== INIT ====== **/
async function boot(){
  await loadData();
  render();
}

/** ====== EVENTS ====== **/
document.getElementById("btnReload").addEventListener("click", async ()=>{
  document.getElementById("subtitle").textContent = "Reloading…";
  await boot();
});
document.getElementById("btnPdf").addEventListener("click", exportPDF);

document.querySelectorAll(".filter").forEach(el=>{
  el.addEventListener("click", ()=>{
    document.querySelectorAll(".filter").forEach(x=>x.classList.remove("active"));
    el.classList.add("active");
    STATE.filter = el.dataset.key;
    render();
  });
});

document.getElementById("btnCalc").addEventListener("click", onCalculate);
document.getElementById("livePrice").addEventListener("keydown", (e)=>{
  if(e.key === "Enter") onCalculate();
});

// if user changes dropdown commodity, clear message
document.getElementById("liveCommodity").addEventListener("change", ()=>{
  document.getElementById("calcMsg").textContent = "";
});

boot();
</script>
</body>
</html>
