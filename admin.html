<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin • Update Verdict CSV</title>
<meta name="theme-color" content="#0b0f14" />
<style>
:root{color-scheme:dark;--bg:#0b0f14;--text:#e6edf3;--muted:#9fb0c3;--line:rgba(255,255,255,.08);--ok:#2fe67a;--bad:#ff5c7a}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);padding:24px}
.wrap{max-width:900px;margin:auto}
header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap;margin-bottom:14px}
h1{margin:0;font-size:20px}
.sub{color:var(--muted);font-size:12px;line-height:1.35;margin-top:6px}
.panel{border:1px solid var(--line);border-radius:16px;background:rgba(255,255,255,.02);overflow:hidden}
.hd{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
.bd{padding:14px}
textarea{
  width:100%;min-height:340px;resize:vertical;
  padding:12px;border-radius:14px;border:1px solid var(--line);
  background:rgba(0,0,0,.25);color:var(--text);
  font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
  font-size:12px;line-height:1.45;outline:none
}
.btn{border:1px solid var(--line);background:rgba(255,255,255,.05);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:900;font-size:13px}
.btn:hover{background:rgba(255,255,255,.08)}
.btn.primary{border-color:rgba(47,230,122,.35);background:rgba(47,230,122,.12)}
.btn.danger{border-color:rgba(255,92,122,.35);background:rgba(255,92,122,.12)}
.row{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}
.msg{margin-top:12px;border-radius:14px;padding:10px 12px;border:1px solid var(--line);background:rgba(255,255,255,.02);white-space:pre-wrap;font-size:12px;line-height:1.35}
.msg.ok{border-color:rgba(47,230,122,.35);background:rgba(47,230,122,.10)}
.msg.bad{border-color:rgba(255,92,122,.35);background:rgba(255,92,122,.10)}
code.inline{background:rgba(255,255,255,.06);padding:2px 6px;border-radius:8px}
a{color:rgba(0,212,255,.9);text-decoration:none;font-weight:900}
a:hover{text-decoration:underline}
</style>
</head>

<body>
<div class="wrap">
  <header>
    <div>
      <h1>Admin • Update Verdict CSV</h1>
      <div class="sub">
        Paste your latest CSV (new template). Click <code class="inline">Save</code>.
        Then open <a href="./index.html">index</a> to see it reflected instantly.
      </div>
    </div>
    <div class="sub" id="meta">No saved data</div>
  </header>

  <section class="panel">
    <div class="hd">
      <div style="font-weight:950">CSV Paste</div>
      <div class="sub">Stored in localStorage</div>
    </div>
    <div class="bd">
      <textarea id="csv" spellcheck="false"></textarea>

      <div class="row">
        <div class="sub" id="stat">0 chars</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
          <button class="btn" id="btnSample">Load sample</button>
          <button class="btn" id="btnValidate">Validate</button>
          <button class="btn primary" id="btnSave">Save</button>
          <button class="btn danger" id="btnClear">Clear</button>
        </div>
      </div>

      <div id="msg" class="msg" style="display:none"></div>
    </div>
  </section>
</div>

<script>
const LS_KEY="VERDICT_CSV";
const LS_TS="VERDICT_CSV_TS";

const SAMPLE=`record_id,date,ltp,capital_inr,market,instrument,mode,verdict,confidence_score_percent,entry_zone,invalid_if_above,risk_per_trade_inr,daily_loss_cap_inr
MCXGOLD-20260220-V2,2026-02-20,154700,35000,MCX,Gold Futures (02APR2026),Intraday,SELL,68,"Below 154600 breakdown","155200",350,700`;

function parseCSV(text){
  const rows=[]; let i=0, f="", row=[], q=false;
  const pf=()=>{ row.push(f); f=""; };
  const pr=()=>{ rows.push(row); row=[]; };
  while(i<text.length){
    const c=text[i];
    if(q){
      if(c==='"'){
        if(text[i+1]==='"'){ f+='"'; i++; } else q=false;
      } else f+=c;
    }else{
      if(c==='"') q=true;
      else if(c===',') pf();
      else if(c==='\n'){ pf(); if(row.length>1 || (row[0]||"").trim()!=="") pr(); }
      else if(c!=='\r') f+=c;
    }
    i++;
  }
  if(f.length || row.length){ pf(); if(row.length>1 || (row[0]||"").trim()!=="") pr(); }
  const header=(rows.shift()||[]).map(x=>String(x||"").trim());
  return rows
    .filter(r=>r.some(x=>String(x||"").trim()!==""))
    .map(r=>{
      const o={};
      header.forEach((h,idx)=>o[h]=String(r[idx]??"").trim());
      return o;
    });
}

function setMeta(){
  const ts=localStorage.getItem(LS_TS);
  const meta=document.getElementById("meta");
  if(!ts){ meta.textContent="No saved data"; return; }
  const d=new Date(Number(ts));
  meta.textContent="Saved: " + (isNaN(d.getTime()) ? ts : d.toLocaleString());
}

function setMsg(text, kind){
  const el=document.getElementById("msg");
  el.style.display="block";
  el.className="msg " + (kind||"");
  el.textContent=text;
}
function clearMsg(){
  const el=document.getElementById("msg");
  el.style.display="none";
  el.textContent="";
  el.className="msg";
}

function validate(raw){
  const t=(raw||"").trim();
  if(!t) return {ok:false, error:"CSV is empty."};

  const rows=parseCSV(t);
  if(!rows.length) return {ok:false, error:"No rows found."};

  const required=["record_id","date","market","instrument","verdict","confidence_score_percent","entry_zone","invalid_if_above"];
  const missing=required.filter(k=>!(k in rows[0]));
  if(missing.length) return {ok:false, error:"Missing columns: " + missing.join(", ")};

  return {ok:true, rows};
}

const $csv=document.getElementById("csv");
const $stat=document.getElementById("stat");

$csv.addEventListener("input", ()=>{ $stat.textContent = ($csv.value||"").length + " chars"; });

document.getElementById("btnSample").addEventListener("click", ()=>{
  $csv.value=SAMPLE;
  $stat.textContent=$csv.value.length + " chars";
  clearMsg();
});

document.getElementById("btnValidate").addEventListener("click", ()=>{
  clearMsg();
  const v=validate($csv.value);
  if(!v.ok) return setMsg(v.error, "bad");
  setMsg("Valid.\nRows: " + v.rows.length, "ok");
});

document.getElementById("btnSave").addEventListener("click", ()=>{
  clearMsg();
  const v=validate($csv.value);
  if(!v.ok) return setMsg("Not saved.\n" + v.error, "bad");

  localStorage.setItem(LS_KEY, $csv.value.trim());
  localStorage.setItem(LS_TS, String(Date.now()));
  setMeta();
  setMsg("Saved.\nOpen index.html to see updated verdict.", "ok");
});

document.getElementById("btnClear").addEventListener("click", ()=>{
  localStorage.removeItem(LS_KEY);
  localStorage.removeItem(LS_TS);
  setMeta();
  setMsg("Cleared saved CSV.", "");
});

(function init(){
  setMeta();
  const existing=localStorage.getItem(LS_KEY);
  if(existing){
    $csv.value=existing;
    $stat.textContent=$csv.value.length + " chars";
  }else{
    $csv.value=SAMPLE;
    $stat.textContent=$csv.value.length + " chars";
  }
})();
</script>
</body>
</html>
